name: e2e

on:
  pull_request:
    types: [ opened, reopened, synchronize ]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    env:
      PROFILE: docker
      PREFIX: sentidas1
      ARCH: amd64
      FRONT: rangiffler-ng-client
      COMPOSE_PROFILES: test
      ALLURE_DOCKER_API: ${{ secrets.ALLURE_DOCKER_API }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BUILD_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      EXECUTION_TYPE: github
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Build backends
        run: |
          ./gradlew jibDockerBuild -x :rangiffler-e-2-e-tests:test
      - name: Pull browsers
        run: |
          docker pull selenoid/vnc_chrome:127.0
      - name: Get the last commit message
        run: |
          echo "HEAD_COMMIT_MESSAGE=$(git show -s --format=%s)" >> $GITHUB_ENV
      - name: Run e2e-tests
        id: e2e
        run: |
          : # 1) ÐŸÐ¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð‘Ð” Ð¸ ÑÑ€Ð°Ð·Ñƒ Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÐ¼ ÐµÑ‘ Ð»Ð¾Ð³Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ð°/Ð¿Ð°Ð´ÐµÐ½Ð¸Ñ
          docker compose up -d rangiffler-all-db

          echo "### Waiting MySQL to be healthy or exited (up to 90s) ###"
          for i in $(seq 1 30); do
            st=$(docker inspect -f '{{.State.Status}}' rangiffler-all-db 2>/dev/null || echo "unknown")
            hs=$(docker inspect -f '{{.State.Health.Status}}' rangiffler-all-db 2>/dev/null || echo "none")
            echo "DB state: $st (health: $hs) [${i}/30]"
            [ "$st" = "exited" ] || [ "$hs" = "healthy" ] && break
            sleep 3
          done

          echo "### MySQL final state ###"
          docker inspect rangiffler-all-db --format 'status={{.State.Status}} exit={{.State.ExitCode}} error={{.State.Error}} started={{.State.StartedAt}} finished={{.State.FinishedAt}}' || true

          echo "### MySQL logs (FULL) ###"
          docker logs rangiffler-all-db || true
          
          
          : # run e2e tests
          docker compose up -d
          docker ps -a

        
          docker wait rangiffler-e-2-e
          exit_code=$(docker inspect -f '{{.State.ExitCode}}' rangiffler-e-2-e)
          echo "E2E_EXIT_CODE=$exit_code" >> $GITHUB_OUTPUT
          echo "### Test logs ###"
          docker logs rangiffler-e-2-e
          if [ "$exit_code" -eq "0" ]; then
            echo "Tests passed successfully!"
            exit 0
          else
            echo "Tests failed!"
            exit 1
          fi
      - name: Add comment to PR with link to allure
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const exitCode = ${{ steps.e2e.outputs.E2E_EXIT_CODE }}
            const reportUrl = 'https://allure.niffler-stage.qa.guru/api/allure-docker-service/projects/rangiffler-sentidas/reports/latest/index.html'
            const historyUrl = 'https://allure.niiffler-stage.qa.guru/allure-docker-service-ui/projects/rangiffler-sentidas'
            const message = exitCode == '0' ?
              `âœ… TEST RUN PASSED âœ… There is the [report](${reportUrl})\nðŸ•“ All reports [history](${historyUrl})` :
              `ðŸ”´ TEST RUN FAILED ðŸ”´ There is the [report](${reportUrl})\nðŸ•“ All reports [history](${historyUrl})`
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })
